# Manifest file downloaded from fusion
externalId: tr_at_p66_source_cr-atl_equipamento
name: at:p66:source:cr-atl:equipamento
query: >-
  WITH equipamento(
    SELECT
    	DISTINCT
    	element.uniqueId AS id_elemento,
    	lower(split_part(element.path, '\\', 5)) AS unidade,
    	substr(element.name,5,4) AS codigo_sistema,
    	element.name AS nome,
    	element.name AS source_name,
    	element.description AS source_description,
    	element.path AS source_path,
    	element.templateName AS source_template_name,
    	sap_local_instalacao.value AS sap_caminho,
    	sap_equipamento.value AS sap_codigo_equipamento,
    	diametro.value AS diametro,
    	operacao.value AS operacao,
    	situacao_operacional.value AS situacao_operacional,
      uep.value AS uep
    FROM `source_table`.`elements` element
    JOIN `source_table`.`attributes` sap_local_instalacao ON element.uniqueId = sap_local_instalacao.parentId
    JOIN `source_table`.`attributes` sap_equipamento ON element.uniqueId = sap_equipamento.parentId
    JOIN `source_table`.`attributes` diametro ON element.uniqueId = diametro.parentId
    JOIN `source_table`.`attributes` operacao ON element.uniqueId = operacao.parentId
    JOIN `source_table`.`attributes` situacao_operacional ON element.uniqueId = situacao_operacional.parentId
    JOIN `source_table`.`attributes` uep ON element.uniqueId = uep.parentId
    WHERE 1=1
    	AND split_part(element.path, '\\', 5) = 'P66'
    	--AND sap_local_instalacao.name = 'Local de instalação - SAP'
      AND startswith(sap_local_instalacao.name, 'Local de instala') AND endswith(sap_local_instalacao.name,'SAP')
    	AND sap_equipamento.name = 'Equipamento - SAP'
    	--AND diametro.name = 'Diâmetro'
    	AND startswith(diametro.name, 'Di') AND endswith(diametro.name,'metro')
    	--AND operacao.name = 'Operação'
    	AND startswith(operacao.name, 'Opera') AND endswith(operacao.name,'o')
    	--AND situacao_operacional.name = 'Situação operacional'
    	AND startswith(situacao_operacional.name, 'Situa') AND endswith(situacao_operacional.name,'operacional')
      AND uep.name = 'UEP'
  ),

  equipamento_bdv(
    SELECT
    	'bdv' AS tipo,
      equipamento.*,
    	tempo_esperado.value AS tempo_esperado
    FROM equipamento
    JOIN `source_table`.`attributes` tempo_esperado ON equipamento.id_elemento = tempo_esperado.parentId
    WHERE 1=1
    	AND tempo_esperado.name = 'Tempo de abertura esperado'
  ),

  equipamento_sdv(
    SELECT
    	'sdv' AS tipo,
      equipamento.*,
    	tempo_esperado.value AS tempo_esperado
    FROM equipamento
    JOIN `source_table`.`attributes` tempo_esperado ON equipamento.id_elemento = tempo_esperado.parentId
    WHERE 1=1
    	AND tempo_esperado.name = 'Tempo de fechamento esperado'
  ),

  todos_equipamento(
    SELECT
    	*
    FROM equipamento_bdv
    UNION
    SELECT
    	*
    FROM equipamento_sdv
  )

  SELECT
    nome AS name,
    concat('at_', unidade,'_', codigo_sistema, '_', lower(nome)) AS externalId,
    concat('at_', unidade,'_', codigo_sistema) AS parentExternalId,
    dataset_id(concat('ds_at_', unidade)) AS dataSetId,
    'source' AS source,
    array('lb_at_equipamento') AS labels,
    map('source_name', source_name,
        'source_path', source_path,
        'source_template_name', source_template_name,
    	  'sap_caminho', sap_caminho,
    	  'sap_codigo_equipamento', sap_codigo_equipamento,
    	  'diametro', diametro,
    	  'operacao', operacao,
    	  'situacao_operacional', situacao_operacional,
    	  'uep', uep,
    	  if(tipo = 'bdv', 'tempo_abertura_esperado', 'tempo_fechamento_esperado'), tempo_esperado
    ) AS metadata
  FROM todos_equipamento
destination:
  type: assets
ignoreNullFields: true
isPublic: true
conflictMode: upsert
dataSetExternalId: ds_at_p66
